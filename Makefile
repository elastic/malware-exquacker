########################
# Helpful make targets #
########################

ifeq ($(shell uname -p), arm)
	DOCKER_BUILD_CMD = buildx build --platform linux/amd64
	DOCKER_RUN_CMD = run --platform linux/amd64
else
	DOCKER_BUILD_CMD = build
	DOCKER_RUN_CMD = run
endif
DOCKER_TAG ?= malware-exquacker

.PHONY: docker-build
docker-build:
	@docker $(DOCKER_BUILD_CMD) . -t $(DOCKER_TAG)

.PHONY: docker-run
docker-run: docker-build
	@docker $(DOCKER_RUN_CMD) --rm -it --env-file .env $(DOCKER_TAG) --help

.PHONY: docker-up
docker-up: docker-build
	@docker-compose up -d --build kafka zookeeper
	@docker-compose up -d --build base-image extract-alerts transform-alerts load-enriched-alerts

.PHONY: docker-down
docker-down:
	@docker-compose down

.PHONY: create-topics
create-topics:
	./scripts/create_topics.sh


.PHONY: venv
venv:
	POETRY_VIRTUALENVS_IN_PROJECT=true poetry install