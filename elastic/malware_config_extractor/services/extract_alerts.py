import json
import time

from confluent_kafka import Producer

from elastic.malware_config_extractor import config, utils
from elastic.malware_config_extractor.extractors import FileAlertExtractor

logger = utils.default_logger(__name__)


def main():
    # Setup input
    alert_extractor = FileAlertExtractor(input_file="etc/sample_input.ndjson")
    alert_extractor._setup_io()

    p = Producer(
        {
            "bootstrap.servers": "kafka",
        }
    )

    for data in alert_extractor.extract():
        p.poll(0)

        if "bytes_compressed" in data.keys():
            logger.debug(f"Posting message {data}")
            p.produce(
                topic=config.QUACKABLE_ALERTS_TOPIC,
                key=f"alert-{int(time.time())}",
                value=f"{json.dumps(data)}",
                callback=utils.delivery_report,
            )
        else:
            logger.info(f">> Cannot exquack this record: {data}")

    p.flush()
    # alert_extractor.es_client.close()


if __name__ == "__main__":
    utils.default_logger()
    main()
