import sys
import time

from confluent_kafka import Producer

from elastic.malware_config_extractor import config, input


def main():
    p = Producer(
        {
            "bootstrap.servers": "kafka",
        }
    )

    # def delivery_report(err, msg):
    #     """Called once for each message produced to indicate delivery result.
    #     Triggered by poll() or flush()."""
    #     if err is not None:
    #         print(f"Message delivery failed: {err}")
    #     else:
    #         print(f"Message delivered to {msg.topic()} [{msg.partition()}]")

    for data in sys.stdin:
        p.poll(0)

        if "malware" in data:
            p.produce(
                topic=f"{config.QUACKABLE_ALERTS_TOPIC}",
                key=f"a-{int(time.time())}",
                value=f"{data.rstrip()}",
                # callback=delivery_report,
            )
        else:
            print(">> This is not malware")

    p.flush()


if __name__ == "__main__":
    main()
